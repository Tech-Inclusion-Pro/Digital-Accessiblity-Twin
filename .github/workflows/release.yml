name: Build & Release AccessTwin

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. 2.4.0)'
        required: true
        default: '2.4.0'

permissions:
  contents: write

jobs:
  build-macos-silicon:
    name: macOS Apple Silicon (arm64)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build with PyInstaller
        run: pyinstaller accesstwin.spec

      - name: Create DMG
        run: |
          brew install create-dmg || true
          create-dmg \
            --volname "AccessTwin" \
            --volicon "assets/AppIcon.icns" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "AccessTwin.app" 150 190 \
            --app-drop-link 450 190 \
            "AccessTwin-macOS-Apple-Silicon.dmg" \
            "dist/AccessTwin.app" || true
          # Fallback to zip if create-dmg fails
          if [ ! -f "AccessTwin-macOS-Apple-Silicon.dmg" ]; then
            cd dist && zip -r ../AccessTwin-macOS-Apple-Silicon.zip AccessTwin.app
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-silicon
          path: |
            AccessTwin-macOS-Apple-Silicon.dmg
            AccessTwin-macOS-Apple-Silicon.zip

  build-macos-intel:
    name: macOS Intel (x86_64)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Enable Rosetta 2
        run: softwareupdate --install-rosetta --agree-to-license || true

      - name: Install x86_64 Python via Homebrew (Rosetta 2)
        run: |
          arch -x86_64 /bin/bash -c '
            eval "$(/usr/local/bin/brew shellenv 2>/dev/null || true)"
            if ! command -v /usr/local/bin/brew &>/dev/null; then
              /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            fi
            /usr/local/bin/brew install python@3.11 || true
          '
          # Verify Python was installed
          test -f /usr/local/bin/python3.11 && echo "Python 3.11 (x86_64) installed successfully"

      - name: Install dependencies (x86_64)
        run: |
          arch -x86_64 /usr/local/bin/python3.11 -m pip install --upgrade pip --break-system-packages
          arch -x86_64 /usr/local/bin/python3.11 -m pip install -r requirements.txt --break-system-packages
          arch -x86_64 /usr/local/bin/python3.11 -m pip install pyinstaller --break-system-packages

      - name: Build with PyInstaller (x86_64)
        run: arch -x86_64 /usr/local/bin/python3.11 -m PyInstaller accesstwin.spec

      - name: Verify architecture
        run: file dist/AccessTwin.app/Contents/MacOS/AccessTwin

      - name: Create DMG
        run: |
          brew install create-dmg || true
          create-dmg \
            --volname "AccessTwin" \
            --volicon "assets/AppIcon.icns" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "AccessTwin.app" 150 190 \
            --app-drop-link 450 190 \
            "AccessTwin-macOS-Intel.dmg" \
            "dist/AccessTwin.app" || true
          # Fallback to zip if create-dmg fails
          if [ ! -f "AccessTwin-macOS-Intel.dmg" ]; then
            cd dist && zip -r ../AccessTwin-macOS-Intel.zip AccessTwin.app
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel
          path: |
            AccessTwin-macOS-Intel.dmg
            AccessTwin-macOS-Intel.zip

  build-windows:
    name: Windows (x64)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build with PyInstaller
        run: pyinstaller accesstwin.spec

      - name: Create ZIP archive
        run: Compress-Archive -Path dist\AccessTwin.exe -DestinationPath AccessTwin-Windows-x64.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: AccessTwin-Windows-x64.zip

  build-linux:
    name: Linux (x86_64)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libegl1 \
            libxkbcommon0 \
            libdbus-1-3 \
            libxcb-cursor0 \
            libxcb-icccm4 \
            libxcb-keysyms1 \
            libxcb-shape0 \
            libportaudio2 \
            libsndfile1

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build with PyInstaller
        run: pyinstaller accesstwin.spec

      - name: Create tarball
        run: |
          chmod +x dist/AccessTwin
          tar -czf AccessTwin-Linux-x86_64.tar.gz -C dist AccessTwin

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-x86_64
          path: AccessTwin-Linux-x86_64.tar.gz

  create-release:
    name: Create GitHub Release
    needs: [build-macos-silicon, build-macos-intel, build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: List artifacts
        run: find release-artifacts -type f

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "TAG=v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
            echo "TAG=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: AccessTwin v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: false
          body: |
            ## AccessTwin v${{ steps.version.outputs.VERSION }}

            **Digital Accessibility Twin Manager** by Tech Inclusion Pro

            ### Downloads

            | Platform | File | Instructions |
            |----------|------|-------------|
            | **macOS (Apple Silicon)** â€” M1/M2/M3/M4 | `AccessTwin-macOS-Apple-Silicon.dmg` | Open the `.dmg`, drag AccessTwin to Applications |
            | **macOS (Intel)** | `AccessTwin-macOS-Intel.dmg` | Open the `.dmg`, drag AccessTwin to Applications |
            | **Windows (64-bit)** | `AccessTwin-Windows-x64.zip` | Extract the `.zip` and run `AccessTwin.exe` |
            | **Linux (x86_64)** | `AccessTwin-Linux-x86_64.tar.gz` | Extract with `tar -xzf` and run `./AccessTwin` |

            ### First Launch Notes

            - **macOS:** If you see "app is damaged" or "unidentified developer", right-click the app and select **Open**, then click **Open** again. Or run: `xattr -cr /Applications/AccessTwin.app`
            - **Windows:** If SmartScreen blocks the app, click **More info** then **Run anyway**
            - **Linux:** You may need to `chmod +x AccessTwin` before running

            ### What's New
            See the [CHANGELOG](https://github.com/Tech-Inclusion-Pro/Digital-Accessiblity-Twin#changelog) in the README for details.
          files: |
            release-artifacts/macos-silicon/*
            release-artifacts/macos-intel/*
            release-artifacts/windows-x64/*
            release-artifacts/linux-x86_64/*
